name: Issue Recorder

on:
  issues:
    types:
      - labeled

jobs:
  build:
    if: github.event.issue.state == 'open' && github.event.label.name == 'done'
    runs-on: ubuntu-latest
    steps:
      # "2024-03-05_sleep_ç¡çœ è¨˜éŒ²" => "2024"
      - name: Get a year
        run: echo "YEAR=$(cut -d '-' -f1 <<< "${{ github.event.issue.title }}")" >> $GITHUB_ENV

      # "2024-03-05_sleep_ç¡çœ è¨˜éŒ²" => "03"
      - name: Get a month
        run: echo "MONTH=$(cut -d '-' -f2 <<< "${{ github.event.issue.title }}")" >> $GITHUB_ENV

      # "2024-03-05_sleep_ç¡çœ è¨˜éŒ²" => "2024-03-05"
      - name: Get a date
        run: echo "DATE=$(cut -d '_' -f1 <<< "${{ github.event.issue.title }}")" >> $GITHUB_ENV

      # "2024-03-05_sleep_ç¡çœ è¨˜éŒ²" => "sleep"
      - name: Get a category
        run: echo "CATEGORY=$(cut -d '_' -f2 <<< "${{ github.event.issue.title }}")" >> $GITHUB_ENV

      # "2024-03-05_sleep_ç¡çœ è¨˜éŒ²" => "ç¡çœ è¨˜éŒ²"
      - name: Get a title
        run: echo "TITLE=$(cut -d '_' -f3 <<< "${{ github.event.issue.title }}")" >> $GITHUB_ENV

      - name: This is a test for Issue Recorder
        uses: noraworld/github-actions-sandbox@main
        with:
          mode: "file"
          # filepath: _posts/${{ env.YEAR }}/${{ env.MONTH }}/${{ github.event.issue.title }}-.md
          # filepath: "issues/${{ github.event.issue.number }}_${{ github.event.issue.title }}.md"
          filepath: ${{ env.CATEGORY }}/${{ env.YEAR }}/${{ env.MONTH }}/${{ env.DATE }}-.md
          committer_name: Kosuke Aoki
          committer_email: mail@noraworld.com
          overwrite_when_modified: true
          extra_text_when_modified: "# issue ã‹ã‚‰ã“ã‚“ã«ã¡ã¯ã§ã™"
          notification_comment: ã“ã®ã‚¿ã‚¹ã‚¯ã®å†…å®¹ã¯ [`<FILE_PATH>`](<FILE_URL_WITH_SHA>) ([<REF_NAME>](<FILE_URL>)) ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚
          # target_file_repo: noraworld/diary
          title_prefix_for_file: ğŸ˜ 
          # target_issue_repo: noraworld/diary
          # target_issue_number: latest
          fold_threshold: 0
          fold_summary: ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å±•é–‹ã§ãã¾ã™
          title_prefix_for_issue: ğŸ¯
          with_date: true
          timezone: Asia/Tokyo
          time_format: h:mm a Â· MMM d, yyyy (ZZZZ)
          # with_header: "---\r\nid: ${{ github.event.issue.number }}\r\ntitle: \"${{ github.event.issue.title }}\"\r\nassignees: ${{ toJson(github.event.issue.assignees.*.login) }}\r\nlabels: ${{ toJson(github.event.issue.labels.*.name) }}\r\ncreated_at: \"${{ github.event.issue.created_at }}\"\r\n---"
          with_header: "---\r\nid: <NUMBER>\r\ntitle: <TITLE>\r\nassignees: <ASSIGNEES>\r\nlabels: <LABELS>\r\ncreated_at: <CREATED_AT>\r\n---"
          with_title: true
          custom_title: ${{ env.TITLE }}
          # with_quote: issue
          # skip_body: "file, issue"
          # personal_access_token: GH_TOKEN
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Make sure the issue is saved successfully
        run: |
          file_content_length=$(gh api "repos/noraworld/github-actions-sandbox/contents/${{ env.CATEGORY }}/${{ env.YEAR }}/${{ env.MONTH }}/${{ env.DATE }}-.md" --jq '.content' | base64 --decode | wc -l)
          issue_content_length=$(gh issue view "${{ github.event.issue.number }}" --json comments --jq '.comments.[].body' | wc -l)

          if [ "$file_content_length" -ge "$issue_content_length" ]; then
            gh issue close "${{ github.event.issue.number }}"
          else
            gh issue edit "${{ github.event.issue.number }}" --remove-label 'done'
            echo "File content length for noraworld/github-actions-sandbox/contents/${{ env.CATEGORY }}/${{ env.YEAR }}/${{ env.MONTH }}/${{ env.DATE }}-.md: $file_content_length" >&2
            echo "Issue content length for ${{ github.event.issue.number }}: $issue_content_length" >&2
            echo "File content length should be greater than or equal to issue content length" >&2
            exit 1
          fi
        shell: sh
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
